<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamStudio Pro | Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                        heading: ['Montserrat', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            dark: '#0f172a',
                            primary: '#0ea5e9',
                            secondary: '#a855f7',
                            accent: '#22d3ee',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            color: #ffffff;
            overflow-x: hidden;
            font-family: 'Poppins', sans-serif;
        }

        .glass {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.7), rgba(15, 23, 42, 0.8));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            transform: translateY(-2px);
            border-color: rgba(34, 211, 238, 0.3);
            box-shadow: 0 10px 30px -10px rgba(34, 211, 238, 0.2);
        }

        .text-gradient {
            background: linear-gradient(to right, #22d3ee, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #0ea5e9, #a855f7);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, #0284c7, #9333ea);
        }

        /* Styles Audio Visualizer */
        .audio-bar {
            width: 4px;
            background: #22d3ee;
            border-radius: 2px;
            transition: height 0.05s ease;
        }

        /* Filters */
        .filter-vintage { filter: sepia(0.5) contrast(1.2); }
        .filter-bw { filter: grayscale(1); }
        .filter-vibrant { filter: saturate(1.5) contrast(1.1); }
        .filter-cinematic { filter: contrast(1.2) brightness(0.9); }
        .filter-cool { filter: hue-rotate(180deg) saturate(1.3); }
        /* Nouveaux filtres */
        .filter-matrix { filter: sepia(1) hue-rotate(50deg) contrast(1.5) saturate(2); }
        .filter-cyber { filter: saturate(2) hue-rotate(200deg) contrast(1.2); }
        .filter-noir { filter: grayscale(1) contrast(2) brightness(0.8); }
        .filter-warm { filter: sepia(0.3) saturate(1.4) brightness(1.1); }
        .filter-ocean { filter: hue-rotate(190deg) contrast(1.1); }
        .filter-soft { filter: brightness(1.1) contrast(0.9) saturate(0.8); }
        .filter-dream { filter: sepia(0.2) brightness(1.2) contrast(0.9) blur(0.5px); }
        
        .active-pip-btn {
            background: #0ea5e9;
            color: white;
            border-color: #0ea5e9;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="fixed w-full z-50 glass">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-video text-2xl text-brand-accent animate-pulse-slow"></i>
                <a href="#" class="text-2xl font-heading font-bold tracking-wider">
                    STREAM<span class="text-brand-primary">STUDIO</span>
                </a>
            </div>
            <div class="flex items-center gap-4">
                <div id="audioVisualizer" class="hidden md:flex items-end gap-1 h-8 w-24 p-1 rounded bg-black/20">
                    <!-- Bars will be injected via JS -->
                </div>
                <a href="#" class="px-5 py-2 rounded-full bg-gradient-to-r from-brand-primary to-brand-secondary hover:opacity-90 transition-opacity font-bold text-sm shadow-lg">
                    <i class="fa-solid fa-home mr-2"></i>Accueil
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="min-h-screen pt-24 pb-12 px-4">
        <div class="max-w-7xl mx-auto">
            <!-- Title -->
            <div class="text-center mb-8">
                <div class="inline-block mb-3 px-4 py-1 rounded-full border border-brand-accent/30 bg-brand-accent/10 text-brand-accent text-sm font-semibold tracking-widest uppercase">
                    Version Ultimate
                </div>
                <h1 class="text-4xl md:text-6xl font-heading font-extrabold mb-4 leading-tight">
                    <span class="text-gradient">StreamStudio</span> Pro
                </h1>
                <p class="text-gray-300 text-lg">Performance optimis√©e, z√©ro latence, cr√©ativit√© illimit√©e</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Main Panel -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Recording Mode -->
                    <div id="modePanel" class="glass-card rounded-2xl p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-heading font-bold flex items-center gap-2">
                                <i class="fa-solid fa-bolt text-yellow-400"></i>
                                Mode de capture
                            </h3>
                            <!-- PiP Controls (Visible only in 'both' mode) -->
                            <div id="pipControls" class="hidden flex gap-2">
                                <span class="text-xs font-bold text-gray-400 uppercase mr-2 self-center">Position Cam√©ra</span>
                                <button onclick="setPipPosition('tl')" class="pip-btn w-8 h-8 rounded border border-gray-600 flex items-center justify-center hover:bg-gray-700 transition-colors" title="Haut Gauche"><i class="fa-solid fa-arrow-up-left"></i></button>
                                <button onclick="setPipPosition('tr')" class="pip-btn w-8 h-8 rounded border border-gray-600 flex items-center justify-center hover:bg-gray-700 transition-colors" title="Haut Droite"><i class="fa-solid fa-arrow-up-right"></i></button>
                                <button onclick="setPipPosition('bl')" class="pip-btn w-8 h-8 rounded border border-gray-600 flex items-center justify-center hover:bg-gray-700 transition-colors" title="Bas Gauche"><i class="fa-solid fa-arrow-down-left"></i></button>
                                <button onclick="setPipPosition('br')" class="pip-btn w-8 h-8 rounded border border-gray-600 flex items-center justify-center hover:bg-gray-700 transition-colors active-pip-btn" title="Bas Droite"><i class="fa-solid fa-arrow-down-right"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <button onclick="setMode('screen')" id="mode-screen" class="mode-btn p-6 rounded-xl border-2 border-gray-700 hover:border-brand-primary/50 transition-all bg-gray-800/50">
                                <i class="fa-solid fa-desktop text-4xl mx-auto mb-3 block"></i>
                                <p class="font-bold">√âcran</p>
                            </button>
                            <button onclick="setMode('webcam')" id="mode-webcam" class="mode-btn p-6 rounded-xl border-2 border-gray-700 hover:border-brand-primary/50 transition-all bg-gray-800/50">
                                <i class="fa-solid fa-camera text-4xl mx-auto mb-3 block"></i>
                                <p class="font-bold">Webcam</p>
                            </button>
                            <button onclick="setMode('both')" id="mode-both" class="mode-btn p-6 rounded-xl border-2 border-gray-700 hover:border-brand-primary/50 transition-all bg-gray-800/50">
                                <div class="flex gap-2 justify-center mb-3">
                                    <i class="fa-solid fa-desktop text-2xl"></i>
                                    <i class="fa-solid fa-camera text-2xl"></i>
                                </div>
                                <p class="font-bold">Les deux</p>
                            </button>
                        </div>
                    </div>

                    <!-- Audio Mode -->
                    <div id="audioPanel" class="glass-card rounded-2xl p-6">
                        <h3 class="text-xl font-heading font-bold mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-volume-high text-yellow-400"></i>
                            Source audio
                        </h3>
                        <div class="grid grid-cols-3 gap-4">
                            <button onclick="setAudioMode('mic')" id="audio-mic" class="audio-btn p-6 rounded-xl border-2 border-gray-700 hover:border-brand-primary/50 transition-all bg-gray-800/50">
                                <i class="fa-solid fa-microphone text-4xl mx-auto mb-3 block"></i>
                                <p class="font-bold">Micro</p>
                            </button>
                            <button onclick="setAudioMode('system')" id="audio-system" class="audio-btn p-6 rounded-xl border-2 border-gray-700 hover:border-brand-primary/50 transition-all bg-gray-800/50">
                                <i class="fa-solid fa-volume-up text-4xl mx-auto mb-3 block"></i>
                                <p class="font-bold">Syst√®me</p>
                            </button>
                            <button onclick="setAudioMode('both')" id="audio-both" class="audio-btn p-6 rounded-xl border-2 border-gray-700 hover:border-brand-primary/50 transition-all bg-gray-800/50">
                                <div class="flex gap-2 justify-center mb-3">
                                    <i class="fa-solid fa-microphone text-2xl"></i>
                                    <i class="fa-solid fa-volume-up text-2xl"></i>
                                </div>
                                <p class="font-bold">Les deux</p>
                            </button>
                        </div>
                    </div>

                    <!-- Preview Area -->
                    <div class="glass-card rounded-2xl p-6">
                        <div class="aspect-video bg-black rounded-lg overflow-hidden mb-6 flex items-center justify-center relative shadow-2xl border border-gray-800">
                            <!-- Latency optimized video element -->
                            <video id="videoPreview" class="w-full h-full hidden" playsinline></video>
                            
                            <div id="placeholder" class="text-center">
                                <div class="relative inline-block">
                                    <i class="fa-solid fa-video text-8xl text-brand-secondary/20 mb-4 transform transition hover:scale-110 duration-500"></i>
                                    <div class="absolute -top-2 -right-2 w-6 h-6 bg-brand-primary rounded-full animate-ping opacity-75"></div>
                                </div>
                                <p class="text-gray-400 text-xl font-semibold">Pr√™t √† cr√©er du contenu</p>
                                <p class="text-gray-600 text-sm mt-2">Cliquez sur un mode pour d√©marrer</p>
                            </div>
                        </div>

                        <!-- Controls -->
                        <div class="flex items-center justify-center gap-4 flex-wrap">
                            <button id="startBtn" onclick="startRecording()" class="flex items-center gap-2 px-10 py-4 rounded-full font-bold transition-all shadow-lg shadow-brand-primary/20 bg-gradient-to-r from-brand-primary to-brand-secondary hover:from-brand-accent hover:to-brand-primary transform hover:scale-105 active:scale-95">
                                <i class="fa-solid fa-circle text-white animate-pulse"></i>
                                D√©marrer l'enregistrement
                            </button>
                            <button id="pauseBtn" onclick="pauseRecording()" class="hidden items-center gap-2 bg-yellow-600 hover:bg-yellow-700 px-8 py-4 rounded-full font-bold transition-all shadow-lg transform hover:scale-105">
                                <i class="fa-solid fa-pause"></i>
                                Pause
                            </button>
                            <button id="stopBtn" onclick="stopRecording()" class="hidden items-center gap-2 bg-red-600 hover:bg-red-700 px-8 py-4 rounded-full font-bold transition-all shadow-lg transform hover:scale-105">
                                <i class="fa-solid fa-square"></i>
                                Arr√™ter
                            </button>
                            <div id="timer" class="hidden bg-gray-900 border border-gray-700 px-8 py-4 rounded-full font-mono text-2xl font-bold text-brand-accent shadow-[0_0_15px_rgba(34,211,238,0.3)]">
                                00:00
                            </div>
                        </div>

                        <div id="recordingStatus" class="hidden mt-6 text-center">
                            <div class="inline-flex items-center gap-2 bg-red-900/30 border border-red-500/50 px-6 py-2 rounded-full">
                                <div class="w-2 h-2 bg-red-500 rounded-full animate-ping"></div>
                                <span class="font-bold text-xs tracking-widest text-red-200">ENREGISTREMENT ACTIF</span>
                            </div>
                        </div>
                    </div>

                    <!-- Volume Control -->
                    <div id="volumeControl" class="glass-card rounded-2xl p-6 hidden">
                        <div class="flex items-center gap-4">
                            <button onclick="toggleMute()" id="muteBtn" class="text-brand-primary hover:text-white transition-colors">
                                <i class="fa-solid fa-volume-high text-xl"></i>
                            </button>
                            <input type="range" id="volumeSlider" min="0" max="100" value="100" class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-brand-primary">
                            <span id="volumeValue" class="text-sm font-bold w-12 text-right">100%</span>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div id="filtersPanel" class="glass-card rounded-2xl p-6 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-heading font-bold flex items-center gap-2">
                                <i class="fa-solid fa-wand-magic-sparkles text-brand-secondary"></i>
                                Studio FX
                            </h3>
                            <span class="text-xs text-gray-400 bg-gray-800 px-2 py-1 rounded">Faible latence activ√©e</span>
                        </div>
                        
                        <div class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2 max-h-[300px] overflow-y-auto custom-scrollbar p-1">
                            <!-- Standard Filters -->
                            <button onclick="applyFilter('none')" class="filter-btn active p-2 rounded-lg border border-gray-700 hover:border-brand-secondary/50 bg-gray-800/50 flex flex-col items-center gap-1 group">
                                <div class="w-8 h-8 rounded-full bg-gray-600 group-hover:bg-brand-secondary transition-colors"></div>
                                <span class="text-[10px] font-medium">Normal</span>
                            </button>
                            
                            <button onclick="applyFilter('vintage')" class="filter-btn p-2 rounded-lg border border-gray-700 hover:border-brand-secondary/50 bg-gray-800/50 flex flex-col items-center gap-1">
                                <div class="w-8 h-8 rounded-full bg-[#8b6c5c]" style="filter: sepia(0.5)"></div>
                                <span class="text-[10px] font-medium">Vintage</span>
                            </button>
                            
                            <button onclick="applyFilter('bw')" class="filter-btn p-2 rounded-lg border border-gray-700 hover:border-brand-secondary/50 bg-gray-800/50 flex flex-col items-center gap-1">
                                <div class="w-8 h-8 rounded-full bg-gray-400" style="filter: grayscale(1)"></div>
                                <span class="text-[10px] font-medium">N&B</span>
                            </button>
                            
                            <button onclick="applyFilter('vibrant')" class="filter-btn p-2 rounded-lg border border-gray-700 hover:border-brand-secondary/50 bg-gray-800/50 flex flex-col items-center gap-1">
                                <div class="w-8 h-8 rounded-full bg-red-400" style="filter: saturate(2)"></div>
                                <span class="text-[10px] font-medium">Vibrant</span>
                            </button>

                            <button onclick="applyFilter('cinematic')" class="filter-btn p-2 rounded-lg border border-gray-700 hover:border-brand-secondary/50 bg-gray-800/50 flex flex-col items-center gap-1">
                                <div class="w-8 h-8 rounded-full bg-blue-900" style="filter: contrast(1.2)"></div>
                                <span class="text-[10px] font-medium">Cin√©ma</span>
                            </button>

                            <!-- New Filters -->
                            <button onclick="applyFilter('matrix')" class="filter-btn p-2 rounded-lg border border-gray-700 hover:border-brand-secondary/50 bg-gray-800/50 flex flex-col items-center gap-1">
                                <div class="w-8 h-8 rounded-full bg-green-500" style="filter: hue-rotate(50deg) contrast(1.5)"></div>
                                <span class="text-[10px] font-medium">Matrix</span>
                            </button>

                            <button onclick="applyFilter('cyber')" class="filter-btn p-2 rounded-lg border border-gray-700 hover:border-brand-secondary/50 bg-gray-800/50 flex flex-col items-center gap-1">
                                <div class="w-8 h-8 rounded-full bg-purple-500" style="filter: hue-rotate(200deg)"></div>
                                <span class="text-[10px] font-medium">Cyber</span>
                            </button>

                            <button onclick="applyFilter('noir')" class="filter-btn p-2 rounded-lg border border-gray-700 hover:border-brand-secondary/50 bg-gray-800/50 flex flex-col items-center gap-1">
                                <div class="w-8 h-8 rounded-full bg-black border border-gray-600"></div>
                                <span class="text-[10px] font-medium">Noir</span>
                            </button>

                            <button onclick="applyFilter('warm')" class="filter-btn p-2 rounded-lg border border-gray-700 hover:border-brand-secondary/50 bg-gray-800/50 flex flex-col items-center gap-1">
                                <div class="w-8 h-8 rounded-full bg-orange-300"></div>
                                <span class="text-[10px] font-medium">Chaud</span>
                            </button>

                            <button onclick="applyFilter('ocean')" class="filter-btn p-2 rounded-lg border border-gray-700 hover:border-brand-secondary/50 bg-gray-800/50 flex flex-col items-center gap-1">
                                <div class="w-8 h-8 rounded-full bg-cyan-600"></div>
                                <span class="text-[10px] font-medium">Oc√©an</span>
                            </button>

                            <button onclick="applyFilter('soft')" class="filter-btn p-2 rounded-lg border border-gray-700 hover:border-brand-secondary/50 bg-gray-800/50 flex flex-col items-center gap-1">
                                <div class="w-8 h-8 rounded-full bg-pink-100"></div>
                                <span class="text-[10px] font-medium">Douceur</span>
                            </button>

                            <button onclick="applyFilter('dream')" class="filter-btn p-2 rounded-lg border border-gray-700 hover:border-brand-secondary/50 bg-gray-800/50 flex flex-col items-center gap-1">
                                <div class="w-8 h-8 rounded-full bg-purple-200" style="filter: blur(1px)"></div>
                                <span class="text-[10px] font-medium">R√™ve</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Library -->
                <div class="space-y-6">
                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-heading font-bold flex items-center gap-2">
                                <i class="fa-solid fa-film text-brand-primary"></i>
                                Biblioth√®que
                            </h3>
                            <span id="videoCount" class="bg-brand-primary px-3 py-1 rounded-full text-sm font-bold shadow-lg">0</span>
                        </div>
                        <div id="videoLibrary" class="space-y-4 max-h-[600px] overflow-y-auto pr-2 custom-scrollbar">
                            <div class="text-center py-12 text-gray-400">
                                <i class="fa-solid fa-film text-6xl opacity-20 mb-4"></i>
                                <p class="text-sm">Vos chefs-d'≈ìuvre appara√Ætront ici</p>
                            </div>
                        </div>
                    </div>
                    <!-- Shortcuts -->
                    <div class="glass-card rounded-2xl p-6">
                        <h3 class="text-xl font-heading font-bold mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-keyboard text-brand-primary"></i>
                            Raccourcis
                        </h3>
                        <ul class="space-y-3 text-sm text-gray-300">
                            <li class="flex justify-between items-center bg-gray-800/30 p-2 rounded"><span class="font-bold text-white">Espace</span> D√©marrer / Stop</li>
                            <li class="flex justify-between items-center bg-gray-800/30 p-2 rounded"><span class="font-bold text-white">P</span> Pause / Reprise</li>
                            <li class="flex justify-between items-center bg-gray-800/30 p-2 rounded"><span class="font-bold text-white">M</span> Mute Micro</li>
                            <li class="flex justify-between items-center bg-gray-800/30 p-2 rounded"><span class="font-bold text-white">F</span> Plein √©cran</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Tips -->
            <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="glass-card rounded-xl p-4 border-l-4 border-blue-500">
                    <p class="text-sm text-gray-300">
                        <strong class="text-blue-400">üí° Astuce :</strong> Utilisez les fl√®ches du panneau Mode pour d√©placer votre webcam.
                    </p>
                </div>
                <div class="glass-card rounded-xl p-4 border-l-4 border-purple-500">
                    <p class="text-sm text-gray-300">
                        <strong class="text-purple-400">‚ö° Performance :</strong> La permission n'est demand√©e qu'une seule fois pour le micro/webcam.
                    </p>
                </div>
                <div class="glass-card rounded-xl p-4 border-l-4 border-green-500">
                    <p class="text-sm text-gray-300">
                        <strong class="text-green-400">üé® Cr√©atif :</strong> Combinez filtres et sources pour un rendu unique.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Globals & Configuration ---
        let isRecording = false;
        let isPaused = false;
        let recordMode = 'screen';
        let audioMode = 'both';
        let mediaRecorder = null;
        let recordedChunks = [];
        let currentStream = null;
        
        // Stream Persistence (New)
        let persistentWebcamStream = null;
        let persistentMicStream = null;
        let activeScreenStream = null;
        
        let audioStream = null;
        let canvas = null;
        let ctx = null;
        let screenVideo = null;
        let webcamVideo = null;
        let drawLoop = null;
        let recordingTime = 0;
        let timerInterval = null;
        let videos = [];
        let currentFilter = 'none';
        let isPlayback = false;
        let currentVideo = null;
        let db = null;
        let pipPosition = 'br'; // tl, tr, bl, br

        // Audio Viz
        let audioContext = null;
        let analyser = null;
        let dataArray = null;
        let vizInterval = null;

        const filterMap = {
            'none': 'none',
            'vintage': 'sepia(0.5) contrast(1.2)',
            'bw': 'grayscale(1)',
            'vibrant': 'saturate(1.5) contrast(1.1)',
            'cinematic': 'contrast(1.2) brightness(0.9)',
            'cool': 'hue-rotate(180deg) saturate(1.3)',
            'matrix': 'hue-rotate(50deg) contrast(1.5) saturate(2)',
            'cyber': 'saturate(2) hue-rotate(200deg) contrast(1.2)',
            'noir': 'grayscale(1) contrast(2) brightness(0.8)',
            'warm': 'sepia(0.3) saturate(1.4) brightness(1.1)',
            'ocean': 'hue-rotate(190deg) contrast(1.1)',
            'soft': 'brightness(1.1) contrast(0.9) saturate(0.8)',
            'dream': 'sepia(0.2) brightness(1.2) contrast(0.9) blur(0.5px)'
        };

        // --- Database ---
        function initDB() {
            const request = indexedDB.open('StreamStudioDB', 1);
            request.onupgradeneeded = (event) => {
                db = event.target.result;
                db.createObjectStore('videos', { keyPath: 'id' });
            };
            request.onsuccess = (event) => {
                db = event.target.result;
                loadVideos();
            };
            request.onerror = (event) => console.error('IndexedDB error:', event.target.error);
        }

        function loadVideos() {
            const transaction = db.transaction('videos', 'readonly');
            const store = transaction.objectStore('videos');
            const request = store.getAll();
            request.onsuccess = (event) => {
                const loaded = event.target.result;
                videos = loaded.map(v => ({...v, url: URL.createObjectURL(v.blob)}));
                updateLibrary();
            };
        }

        function saveVideoToDB(video) {
            const videoToStore = {...video};
            delete videoToStore.url;
            const transaction = db.transaction('videos', 'readwrite');
            const store = transaction.objectStore('videos');
            store.add(videoToStore);
        }

        function updateVideoInDB(video) {
            const videoToStore = {...video};
            delete videoToStore.url;
            const transaction = db.transaction('videos', 'readwrite');
            const store = transaction.objectStore('videos');
            store.put(videoToStore);
        }

        // --- Stream Management (Optimized) ---
        
        // Helper to check if a stream is active
        function isStreamActive(stream) {
            return stream && stream.active && stream.getTracks().some(t => t.readyState === 'live');
        }

        async function getWebcamStream() {
            if (isStreamActive(persistentWebcamStream)) {
                return persistentWebcamStream;
            }
            try {
                persistentWebcamStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 1280, height: 720, frameRate: { ideal: 30 } }, 
                    audio: false 
                });
                return persistentWebcamStream;
            } catch (e) {
                console.error("Webcam access denied", e);
                return null;
            }
        }

        async function getMicStream() {
            if (isStreamActive(persistentMicStream)) {
                return persistentMicStream;
            }
            try {
                persistentMicStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true } 
                });
                return persistentMicStream;
            } catch (e) {
                console.error("Mic access denied", e);
                return null;
            }
        }

        async function getScreenStream() {
            // Screen stream almost always needs user gesture, but we can reuse if active
            if (isStreamActive(activeScreenStream)) {
                return activeScreenStream;
            }
            try {
                activeScreenStream = await navigator.mediaDevices.getDisplayMedia({ 
                    video: { frameRate: { ideal: 30 } }, 
                    audio: true 
                });
                // Handle user stopping screen share via browser UI
                activeScreenStream.getVideoTracks()[0].onended = () => {
                    if (recordMode === 'screen' || recordMode === 'both') {
                        stopRecording();
                        resetToPlaceholder();
                    }
                };
                return activeScreenStream;
            } catch (e) {
                console.error("Screen share denied", e);
                // Handle Iframe Permissions Policy Error gracefully
                if (e.name === 'NotAllowedError' && e.message.includes('policy')) {
                    alert("‚ö†Ô∏è L'enregistrement d'√©cran est bloqu√© par la politique de s√©curit√© du navigateur.\n\nPour utiliser cette fonction :\n1. Essayez d'ouvrir cette page dans un nouvel onglet.\n2. Ou utilisez le mode Webcam uniquement.");
                } else if (e.name === 'NotAllowedError') {
                    // Standard user denial, usually safe to ignore as user clicked 'Cancel'
                } else {
                    alert("Erreur lors de l'acc√®s √† l'√©cran: " + e.message);
                }
                return null;
            }
        }

        // --- Core Logic ---

        async function setMode(mode) {
            recordMode = mode;
            stopCurrentPreviewLogic(); // Stop canvas loop, but KEEP raw streams if possible
            
            // UI Update
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('bg-brand-primary', 'border-brand-primary');
                btn.classList.add('bg-gray-800/50', 'border-gray-700');
            });
            document.getElementById(`mode-${mode}`).classList.remove('bg-gray-800/50', 'border-gray-700');
            document.getElementById(`mode-${mode}`).classList.add('bg-brand-primary', 'border-brand-primary');
            
            // Show/Hide PiP controls
            const pipControls = document.getElementById('pipControls');
            if (mode === 'both') pipControls.classList.remove('hidden');
            else pipControls.classList.add('hidden');

            isPlayback = false;
            currentVideo = null;
            
            await setupPreview();
        }

        async function setAudioMode(mode) {
            audioMode = mode;
            document.querySelectorAll('.audio-btn').forEach(btn => {
                btn.classList.remove('bg-brand-primary', 'border-brand-primary');
                btn.classList.add('bg-gray-800/50', 'border-gray-700');
            });
            document.getElementById(`audio-${mode}`).classList.remove('bg-gray-800/50', 'border-gray-700');
            document.getElementById(`audio-${mode}`).classList.add('bg-brand-primary', 'border-brand-primary');
            
            await updateAudioStream();
            // Reconfigure preview ONLY if we are already live
            if (!document.getElementById('videoPreview').classList.contains('hidden')) {
               // Just updating audio doesn't require full visual reset usually, but safe to reload composition
               if (currentStream) {
                   // Replace audio track in current stream if possible without full reset?
                   // Easier to full reset for sync
                   setupPreview();
               }
            }
        }

        function setPipPosition(pos) {
            pipPosition = pos;
            document.querySelectorAll('.pip-btn').forEach(btn => btn.classList.remove('active-pip-btn'));
            document.querySelector(`.pip-btn[onclick="setPipPosition('${pos}')"]`).classList.add('active-pip-btn');
            // Canvas will pick up new position automatically in drawFrame
        }

        async function updateAudioStream() {
            // Stop current composite audio logic
            if (audioContext && audioContext.state !== 'closed') {
                // Keep context if we want, but simpler to rebuild graph
            }

            let micStrm = null;
            let sysStrm = null;

            if (audioMode === 'mic' || audioMode === 'both') {
                micStrm = await getMicStream();
            }
            if ((audioMode === 'system' || audioMode === 'both') && activeScreenStream) {
                // System audio comes from screen stream
                if (activeScreenStream.getAudioTracks().length > 0) {
                    sysStrm = new MediaStream([activeScreenStream.getAudioTracks()[0]]);
                }
            }

            // Mix Audio
            const tracks = [];
            if (micStrm) tracks.push(micStrm.getAudioTracks()[0]);
            if (sysStrm) tracks.push(sysStrm.getAudioTracks()[0]);

            if (tracks.length === 0) {
                audioStream = null;
                stopVisualizer();
                return;
            }

            if (tracks.length === 1 && !analyser) { 
                // Simple case, no mixing needed, but we want Visualizer so we use WebAudio anyway
            }

            // Web Audio API for mixing and Visualizer
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const destination = audioContext.createMediaStreamDestination();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 32;

            if (micStrm) {
                const src = audioContext.createMediaStreamSource(micStrm);
                src.connect(destination);
                src.connect(analyser); // Visualize mic
            }
            if (sysStrm) {
                const src = audioContext.createMediaStreamSource(sysStrm);
                src.connect(destination);
                // We typically visualize mic mostly, but could mix
            }

            audioStream = destination.stream;
            startVisualizer();
        }

        function startVisualizer() {
            const vizContainer = document.getElementById('audioVisualizer');
            vizContainer.innerHTML = '';
            // Create bars
            for(let i=0; i<8; i++) {
                const bar = document.createElement('div');
                bar.className = 'audio-bar h-1';
                vizContainer.appendChild(bar);
            }
            const bars = document.querySelectorAll('.audio-bar');
            
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            function updateViz() {
                if (!analyser) return;
                analyser.getByteFrequencyData(dataArray);
                
                // Simple visualization logic
                for(let i=0; i<8; i++) {
                    const val = dataArray[i];
                    const height = Math.max(4, (val / 255) * 32); // Max height 32px
                    bars[i].style.height = `${height}px`;
                }
                vizInterval = requestAnimationFrame(updateViz);
            }
            updateViz();
        }

        function stopVisualizer() {
            if (vizInterval) cancelAnimationFrame(vizInterval);
            const bars = document.querySelectorAll('.audio-bar');
            bars.forEach(b => b.style.height = '4px');
        }

        async function setupPreview() {
            stopCurrentPreviewLogic(); // Kill existing canvas/video elements logic
            
            const videoEl = document.getElementById('videoPreview');
            const placeholder = document.getElementById('placeholder');
            
            try {
                // Fetch required streams based on mode
                let videoSource = null;
                let secondarySource = null;

                if (recordMode === 'screen' || recordMode === 'both') {
                    videoSource = await getScreenStream();
                    if (!videoSource) { resetToPlaceholder(); return; }
                }
                
                if (recordMode === 'webcam' || recordMode === 'both') {
                    // For webcam mode, it's main source. For both, it's secondary.
                    const wb = await getWebcamStream();
                    if (!wb) { 
                        if (recordMode === 'webcam') { resetToPlaceholder(); return; }
                        // If both and webcam fails, maybe continue with just screen?
                        // For now strict fail
                    }
                    if (recordMode === 'webcam') videoSource = wb;
                    else secondarySource = wb;
                }

                // Audio setup
                await updateAudioStream();

                // UI Ready
                videoEl.classList.remove('hidden');
                placeholder.classList.add('hidden');
                document.getElementById('filtersPanel').classList.remove('hidden');
                document.getElementById('volumeControl').classList.remove('hidden');
                
                // --- Composition Logic ---
                // We ALWAYS use Canvas now to support seamless filters and mixing without flickering
                startCanvasComposition(videoSource, secondarySource);

            } catch (error) {
                console.error("Setup Error", error);
                alert("Erreur d'acc√®s aux p√©riph√©riques. V√©rifiez les permissions.");
                resetToPlaceholder();
            }
        }

        function startCanvasComposition(mainStream, secStream) {
            const videoEl = document.getElementById('videoPreview');
            
            canvas = document.createElement('canvas');
            canvas.width = 1280;
            canvas.height = 720;
            // 'alpha: false' for performance since we don't need transparency
            ctx = canvas.getContext('2d', { alpha: false, willReadFrequently: true });

            // Create hidden video elements to read from
            if (recordMode === 'screen' || recordMode === 'both') {
                screenVideo = document.createElement('video');
                screenVideo.srcObject = mainStream;
                screenVideo.muted = true;
                screenVideo.play();
            } else if (recordMode === 'webcam') {
                webcamVideo = document.createElement('video');
                webcamVideo.srcObject = mainStream;
                webcamVideo.muted = true;
                webcamVideo.play();
            }

            if (recordMode === 'both' && secStream) {
                webcamVideo = document.createElement('video');
                webcamVideo.srcObject = secStream;
                webcamVideo.muted = true;
                webcamVideo.play();
            }

            function drawFrame() {
                if (!ctx) return;
                
                // Background (Main)
                ctx.filter = filterMap[currentFilter];
                
                if (recordMode === 'screen' || recordMode === 'both') {
                    if (screenVideo && screenVideo.readyState >= 2) {
                        ctx.drawImage(screenVideo, 0, 0, canvas.width, canvas.height);
                    }
                } else if (recordMode === 'webcam') {
                    if (webcamVideo && webcamVideo.readyState >= 2) {
                        ctx.drawImage(webcamVideo, 0, 0, canvas.width, canvas.height);
                    }
                }

                // PiP (Secondary)
                if (recordMode === 'both' && webcamVideo && webcamVideo.readyState >= 2) {
                    ctx.filter = 'none'; // No filter on PiP frame usually, or same? let's keep it raw for clarity
                    // Or apply same filter? Let's apply same filter for consistency
                    ctx.filter = filterMap[currentFilter]; 
                    
                    const w = 320;
                    const h = 240;
                    const pad = 20;
                    let x, y;

                    switch(pipPosition) {
                        case 'tl': x = pad; y = pad; break;
                        case 'tr': x = canvas.width - w - pad; y = pad; break;
                        case 'bl': x = pad; y = canvas.height - h - pad; break;
                        case 'br': default: x = canvas.width - w - pad; y = canvas.height - h - pad; break;
                    }
                    
                    // Add border/shadow to PiP
                    ctx.strokeStyle = '#22d3ee';
                    ctx.lineWidth = 4;
                    ctx.strokeRect(x, y, w, h);
                    ctx.drawImage(webcamVideo, x, y, w, h);
                }

                drawLoop = requestAnimationFrame(drawFrame);
            }
            
            drawLoop = requestAnimationFrame(drawFrame);

            // Stream from canvas
            const canvasStream = canvas.captureStream(30);
            if (audioStream) {
                audioStream.getAudioTracks().forEach(track => canvasStream.addTrack(track));
            }
            
            currentStream = canvasStream;
            videoEl.srcObject = currentStream;
            videoEl.muted = true; // Local preview muted to avoid echo
            videoEl.play();
        }

        function stopCurrentPreviewLogic() {
            if (drawLoop) cancelAnimationFrame(drawLoop);
            if (screenVideo) { screenVideo.pause(); screenVideo = null; }
            if (webcamVideo) { webcamVideo.pause(); webcamVideo = null; }
            
            const videoEl = document.getElementById('videoPreview');
            videoEl.srcObject = null;
            
            // NOTE: We do NOT stop tracks here to allow persistence
            // Tracks are only stopped if we explicitly want to kill permissions or closing app
        }

        function resetToPlaceholder() {
            stopCurrentPreviewLogic();
            const videoEl = document.getElementById('videoPreview');
            const placeholder = document.getElementById('placeholder');
            videoEl.classList.add('hidden');
            placeholder.classList.remove('hidden');
            document.getElementById('filtersPanel').classList.add('hidden');
            document.getElementById('volumeControl').classList.add('hidden');
        }

        // --- Recording Logic ---

        async function startCountdown() {
            const timerEl = document.getElementById('timer');
            timerEl.classList.remove('hidden');
            timerEl.classList.add('flex');
            for (let i = 3; i > 0; i--) {
                timerEl.textContent = i;
                await new Promise(resolve => setTimeout(resolve, 800)); // Slightly faster 
            }
            timerEl.textContent = '00:00';
        }

        async function startRecording() {
            if (!currentStream || currentStream.active === false) {
                // Try to reconnect if stream was lost or never started
                await setupPreview(); 
                // Double check
                if(!currentStream || currentStream.active === false) {
                    alert("Aucune source vid√©o active. Veuillez s√©lectionner un mode (√âcran ou Webcam) d'abord.");
                    return;
                }
            }
            
            try {
                await startCountdown();
                recordedChunks = [];
                
                // Higher bitrate for Pro quality
                const options = { mimeType: 'video/webm;codecs=vp8', videoBitsPerSecond: 5000000 };
                mediaRecorder = new MediaRecorder(currentStream, options);
                
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) recordedChunks.push(e.data);
                };
                
                mediaRecorder.onstop = saveVideo;
                
                mediaRecorder.start(1000);
                isRecording = true;
                
                // UI updates
                document.getElementById('startBtn').classList.add('hidden');
                document.getElementById('pauseBtn').classList.remove('hidden');
                document.getElementById('pauseBtn').classList.add('flex');
                document.getElementById('stopBtn').classList.remove('hidden');
                document.getElementById('stopBtn').classList.add('flex');
                document.getElementById('recordingStatus').classList.remove('hidden');
                document.getElementById('modePanel').classList.add('pointer-events-none', 'opacity-50');
                
                startTimer();
                
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                isPaused = false;
                stopTimer();
                
                // UI Reset
                document.getElementById('startBtn').classList.remove('hidden');
                document.getElementById('pauseBtn').classList.add('hidden');
                document.getElementById('stopBtn').classList.add('hidden');
                document.getElementById('timer').classList.add('hidden');
                document.getElementById('recordingStatus').classList.add('hidden');
                document.getElementById('modePanel').classList.remove('pointer-events-none', 'opacity-50');
                
                // We keep preview running!
            }
        }

        function pauseRecording() {
            if (isPaused) {
                mediaRecorder.resume();
                startTimer();
                document.getElementById('pauseBtn').innerHTML = '<i class="fa-solid fa-pause"></i> Pause';
            } else {
                mediaRecorder.pause();
                stopTimer();
                document.getElementById('pauseBtn').innerHTML = '<i class="fa-solid fa-play"></i> Reprendre';
            }
            isPaused = !isPaused;
        }

        function saveVideo() {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const desc = prompt('Nom de votre cr√©ation :', `Enregistrement ${videos.length + 1}`);
            
            const video = {
                id: Date.now(),
                blob: blob,
                duration: recordingTime,
                timestamp: new Date().toLocaleString('fr-FR'),
                mode: recordMode,
                filter: currentFilter,
                name: desc || `Vid√©o #${videos.length + 1}`
            };
            
            saveVideoToDB(video);
            videos.unshift({...video, url: url});
            updateLibrary();
            
            recordingTime = 0;
            document.getElementById('timer').textContent = '00:00';
        }

        // --- Library & Playback ---

        function updateLibrary() {
            document.getElementById('videoCount').textContent = videos.length;
            const library = document.getElementById('videoLibrary');
            
            if (videos.length === 0) {
                library.innerHTML = '<div class="text-center py-12 text-gray-400"><i class="fa-solid fa-film text-6xl opacity-20 mb-4"></i><p class="text-sm">Vos vid√©os appara√Ætront ici</p></div>';
                return;
            }
            
            library.innerHTML = videos.map(video => `
                <div class="glass-card p-4 rounded-xl border border-transparent hover:border-brand-primary/50 cursor-pointer transition-all group" onclick="playVideo(${video.id})">
                    <div class="flex items-start gap-3 mb-3">
                        <div class="bg-gradient-to-br from-brand-primary to-brand-secondary p-3 rounded-lg shadow-lg group-hover:shadow-brand-primary/30 transition-shadow">
                            <i class="fa-solid fa-${video.mode === 'screen' ? 'desktop' : video.mode === 'webcam' ? 'camera' : 'video'} text-xl text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-bold truncate text-white group-hover:text-brand-accent transition-colors">${video.name}</p>
                            <p class="text-xs text-gray-400">${video.timestamp}</p>
                            <div class="flex items-center gap-2 mt-2">
                                <span class="text-[10px] bg-gray-700 px-2 py-0.5 rounded text-gray-300">${formatTime(video.duration)}</span>
                                ${video.filter !== 'none' ? `<span class="text-[10px] bg-brand-secondary/20 text-brand-secondary px-2 py-0.5 rounded border border-brand-secondary/30">${video.filter}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="event.stopPropagation(); downloadVideo(${video.id})" class="flex-1 bg-green-600 hover:bg-green-700 py-1.5 rounded text-xs font-bold transition-colors">
                            <i class="fa-solid fa-download mr-1"></i> MP4
                        </button>
                        <button onclick="event.stopPropagation(); deleteVideo(${video.id})" class="bg-red-500/20 hover:bg-red-500 hover:text-white text-red-400 py-1.5 px-3 rounded text-xs transition-colors">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function playVideo(id) {
            // Find video logic (since we pass ID now to avoid stringify issues)
            const video = videos.find(v => v.id === id);
            if(!video) return;

            stopCurrentPreviewLogic(); // Stop camera/screen preview
            
            const videoEl = document.getElementById('videoPreview');
            const placeholder = document.getElementById('placeholder');
            
            videoEl.srcObject = null;
            videoEl.src = video.url;
            videoEl.muted = false;
            videoEl.controls = true;
            videoEl.classList.remove('hidden');
            placeholder.classList.add('hidden');
            
            // Adjust UI for playback
            document.getElementById('filtersPanel').classList.add('hidden');
            document.getElementById('startBtn').classList.add('hidden');
            
            // Add a "Retour" button logic handled by re-clicking mode buttons
            
            isPlayback = true;
            currentVideo = video;
            videoEl.play();
        }

        function downloadVideo(id) {
            const video = videos.find(v => v.id === id);
            if (!video) return;
            const a = document.createElement('a');
            a.href = video.url;
            a.download = `${video.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${video.id}.webm`;
            a.click();
        }

        function deleteVideo(id) {
            if (!confirm('Supprimer d√©finitivement cette vid√©o ?')) return;
            const video = videos.find(v => v.id === id);
            if (video) URL.revokeObjectURL(video.url);
            
            videos = videos.filter(v => v.id !== id);
            
            const tx = db.transaction('videos', 'readwrite');
            tx.objectStore('videos').delete(id);
            
            updateLibrary();
            if (currentVideo && currentVideo.id === id) {
                resetToPlaceholder();
                setMode(recordMode); // Return to preview
            }
        }

        // --- Helpers ---

        function applyFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'border-brand-secondary');
                btn.classList.add('border-gray-700');
            });
            const active = document.querySelector(`.filter-btn[onclick="applyFilter('${filter}')"]`);
            if(active) {
                active.classList.add('active', 'border-brand-secondary');
                active.classList.remove('border-gray-700');
            }
            // Filter is applied in drawFrame loop automatically
        }

        function toggleMute() {
            if(audioStream) {
                const tracks = audioStream.getAudioTracks();
                tracks.forEach(t => t.enabled = !t.enabled);
                const btn = document.getElementById('muteBtn');
                if(tracks[0].enabled) {
                    btn.innerHTML = '<i class="fa-solid fa-volume-high text-xl"></i>';
                    btn.classList.remove('text-red-500');
                    btn.classList.add('text-brand-primary');
                } else {
                    btn.innerHTML = '<i class="fa-solid fa-volume-xmark text-xl"></i>';
                    btn.classList.add('text-red-500');
                    btn.classList.remove('text-brand-primary');
                }
            }
        }

        function startTimer() {
            stopTimer();
            timerInterval = setInterval(() => {
                recordingTime++;
                document.getElementById('timer').textContent = formatTime(recordingTime);
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) clearInterval(timerInterval);
        }

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = s % 60;
            return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }

        // --- Init ---
        initDB();
        // Modification: Ne pas lancer setupPreview (setMode) automatiquement au chargement
        // Cela √©vite l'erreur "Access to the feature "display-capture" is disallowed by permissions policy"
        // On initialise juste l'√©tat visuel du bouton
        recordMode = 'screen'; 
        document.getElementById('mode-screen').classList.remove('bg-gray-800/50', 'border-gray-700');
        document.getElementById('mode-screen').classList.add('bg-brand-primary', 'border-brand-primary');
        resetToPlaceholder();
        
        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            if(e.code === 'Space' && !isPlayback) {
                e.preventDefault();
                // Check if we have an active stream before trying to record
                if (isRecording) stopRecording();
                else startRecording();
            }
            if(e.code === 'KeyP' && isRecording) {
                pauseRecording();
            }
            if(e.code === 'KeyM') {
                toggleMute();
            }
            if(e.code === 'KeyF') {
                const el = document.getElementById('videoPreview');
                if(document.fullscreenElement) document.exitFullscreen();
                else el.requestFullscreen();
            }
        });
        
        // Volume
        document.getElementById('volumeSlider').addEventListener('input', (e) => {
           const vid = document.getElementById('videoPreview');
           vid.volume = e.target.value / 100;
           document.getElementById('volumeValue').innerText = e.target.value + '%';
        });
    </script>
</body>
</html>